generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- NEXT AUTH (Obrigatorios) ---

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // Custom fields
  phone String? // Para notificações de agendamento via Zap
  role  UserRole @default(USER)

  // Relacionamentos
  accounts Account[]
  sessions Session[]
  bookings Booking[]

  // Se ele for dono, quais barbearias ele tem?
  ownedBarbershops BarberShop[] @relation("BarberOwner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- ENUMS ---

enum UserRole {
  USER // Cliente
  BARBER_OWNER // Dono da Barbearia
  ADMIN // Luiz (Super Admin)
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  PENDING
}

enum PaymentMethod {
  PIX
  CARD
  CASH
}

enum BarberShopPlan {
  START
  PRO
}

// --- MODELS DO SAAS ---

model BarberShop {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  address     String
  phones      String[]
  description String
  imageUrl    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Dono da Barbearia (Link com NextAuth)
  ownerId String?
  owner   User?   @relation("BarberOwner", fields: [ownerId], references: [id])

  // --- ESTRUTURA SAAS / STRIPE ---
  stripeCustomerId         String?
  stripeSubscriptionId     String?
  stripeSubscriptionStatus Boolean @default(true)
  stripePriceId            String? // Para saber se é plano Basic ou Pro
  subscriptionEndsAt       DateTime? // Data vital para controlar acesso

  // PLANO ATUAL
  plan BarberShopPlan @default(START)
  trialEndsAt DateTime?

  //  CONTROLE DO PLANO START (Trava de edição de preços)
  lastMenuUpdatedAt DateTime?

  // Relacionamentos
  services     BarberServices[]
  bookings     Booking[]
  openingHours BarberShopOpeningHours[]

  //  EQUIPE (Multi-barbeiros)
  barbers Barber[]
}

//  MODELO DA EQUIPE (BARBEIROS)
model Barber {
  id             String  @id @default(uuid())
  name           String
  imageUrl       String? // Foto do barbeiro
  commissionRate Int     @default(0) // Porcentagem (0 a 100)
  isActive       Boolean @default(true) // Se sair da barbearia, vira false

  barberShopId String
  barberShop   BarberShop @relation(fields: [barberShopId], references: [id], onDelete: Cascade)

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// TABELA PARA AGENDAMENTO REAL
model BarberShopOpeningHours {
  id String @id @default(uuid())

  dayOfWeek Int // 0 = Dom, 1 = Seg, 2 = Ter...
  startTime String // "09:00"
  endTime   String // "18:00"

  barberShopId String
  barberShop   BarberShop @relation(fields: [barberShopId], references: [id], onDelete: Cascade)
}

model BarberServices {
  id          String  @id @default(uuid())
  name        String
  description String
  imageUrl    String
  price       Decimal @db.Decimal(10, 2)

  barberShopId String
  barberShop   BarberShop @relation(fields: [barberShopId], references: [id], onDelete: Cascade)
  isHidden    Boolean  @default(false)

  bookings Booking[]
}

model Booking {
  id String @id @default(uuid())

  // Cliente (User do NextAuth)
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Barbearia
  barberShopId String
  barberShop   BarberShop @relation(fields: [barberShopId], references: [id], onDelete: Cascade)

  // Serviço
  serviceId String
  service   BarberServices @relation(fields: [serviceId], references: [id])
  price     Decimal        @db.Decimal(10, 2)

  barberId String?
  barber   Barber? @relation(fields: [barberId], references: [id])

  date          DateTime
  status        BookingStatus @default(CONFIRMED)
  paymentMethod PaymentMethod @default(CASH)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
